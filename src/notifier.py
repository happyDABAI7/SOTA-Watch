import os
import requests
import json
import datetime
from dotenv import load_dotenv

load_dotenv()

def send_to_feishu(content: str, webhook_url: str):
    """
    å‘é€é£ä¹¦å¡ç‰‡æ¶ˆæ¯
    """
    # æ„é€ é£ä¹¦å¡ç‰‡ JSON ç»“æ„
    # æˆ‘ä»¬ä½¿ç”¨ 'interactive' ç±»å‹ï¼Œå®ƒæ”¯æŒ Markdown æ¸²æŸ“
    payload = {
        "msg_type": "interactive",
        "card": {
            "header": {
                "title": {
                    "tag": "plain_text",
                    "content": f"ğŸš¨ SOTA Watch Daily ({datetime.date.today()})"
                },
                "template": "blue" # æ ‡é¢˜é¢œè‰²ï¼šblue, wathet, turquoise, green, yellow, orange, red, carmine, violet, purple, indigo, grey
            },
            "elements": [
                {
                    "tag": "markdown",
                    "content": content
                },
                {
                    "tag": "note",
                    "elements": [
                        {
                            "tag": "plain_text",
                            "content": f"Generated by AI Agent at {datetime.datetime.now().strftime('%H:%M')}"
                        }
                    ]
                }
            ]
        }
    }

    try:
        response = requests.post(
            webhook_url, 
            headers={"Content-Type": "application/json"}, 
            json=payload
        )
        
        # æ£€æŸ¥é£ä¹¦çš„è¿”å›ç»“æœ
        result = response.json()
        if result.get("code") == 0:
            print("âœ… [Feishu] Notification sent successfully!")
        else:
            print(f"âŒ [Feishu] Failed. Error: {result}")
            
    except Exception as e:
        print(f"âŒ [Feishu] Connection error: {e}")

def send_notification(content: str):
    """
    ä¸»é€šçŸ¥å…¥å£
    """
    print("\nğŸ“¨ [Notifier] Preparing notification...")
    
    # 1. æ€»æ˜¯ä¿å­˜ä¸€ä»½åˆ°æœ¬åœ° (å¤‡ä»½)
    today = datetime.date.today().strftime("%Y-%m-%d")
    filename = f"sota_report_{today}.md"
    try:
        with open(filename, "a", encoding="utf-8") as f:
            f.write(f"\n\nğŸ•’ Run Time: {datetime.datetime.now().strftime('%H:%M:%S')}\n")
            f.write(content)
        print(f"âœ… Report saved to local file: {filename}")
    except Exception as e:
        print(f"âŒ Failed to save local file: {e}")

    # 2. æ£€æŸ¥æ˜¯å¦æœ‰é£ä¹¦é…ç½®
    feishu_url = os.getenv("FEISHU_WEBHOOK")
    
    if feishu_url:
        print("ğŸš€ Sending to Feishu...")
        send_to_feishu(content, feishu_url)
    else:
        print("â„¹ï¸  No FEISHU_WEBHOOK found in .env. Skipping cloud notification.")